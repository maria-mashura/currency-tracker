<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Currency Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 90%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        h2 { margin-top: 40px; }
        .best-buy { background-color: #c8e6c9; font-weight: bold; } /* зеленый для лучшего Buy */
        .best-sell { background-color: #ffcdd2; font-weight: bold; } /* красный для худшего Sell */
    </style>
</head>
<body>
    <h1>Currency Tracker</h1>

    <h2>Current Rates (sorted by Buy rate descending)</h2>
    <table id="currentRates">
        <thead>
            <tr>
                <th>Bank</th>
                <th>Currency</th>
                <th>Buy Rate</th>
                <th>Sell Rate</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Historical Rates (sorted by Buy rate descending)</h2>
    <table id="historicalRates">
        <thead>
            <tr>
                <th>Bank</th>
                <th>Currency</th>
                <th>Buy Rate</th>
                <th>Sell Rate</th>
                <th>Date & Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    async function loadRates() {
        try {
            const response = await fetch('http://127.0.0.1:8000/rates/latest');
            const data = await response.json();

            // --- Current Rates ---
            const latestMap = {};
            data.rates.forEach(rate => {
                const key = rate.bank + "_" + rate.currency;
                if (!latestMap[key] || new Date(rate.date) > new Date(latestMap[key].date)) {
                    latestMap[key] = rate;
                }
            });

            const latestArray = Object.values(latestMap);

            // Найти для каждой валюты лучший Buy и худший Sell
            const bestBuy = {};
            const worstSell = {};
            latestArray.forEach(rate => {
                if (!bestBuy[rate.currency] || rate.buy > bestBuy[rate.currency]) {
                    bestBuy[rate.currency] = rate.buy;
                }
                if (!worstSell[rate.currency] || rate.sell < worstSell[rate.currency]) {
                    worstSell[rate.currency] = rate.sell;
                }
            });

            // Сортировка по Buy
            latestArray.sort((a,b) => b.buy - a.buy);

            const tbodyCurrent = document.querySelector('#currentRates tbody');
            tbodyCurrent.innerHTML = '';
            latestArray.forEach(rate => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${rate.bank}</td>
                    <td>${rate.currency}</td>
                    <td class="${rate.buy === bestBuy[rate.currency] ? 'best-buy' : ''}">${rate.buy.toFixed(2)}</td>
                    <td class="${rate.sell === worstSell[rate.currency] ? 'best-sell' : ''}">${rate.sell.toFixed(2)}</td>
                    <td>${rate.date}</td>
                `;
                tbodyCurrent.appendChild(row);
            });

            // --- Historical Rates ---
            const historicalArray = [...data.rates];
            historicalArray.sort((a,b) => b.buy - a.buy);

            const tbodyHist = document.querySelector('#historicalRates tbody');
            tbodyHist.innerHTML = '';
            historicalArray.forEach(rate => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rate.bank}</td>
                    <td>${rate.currency}</td>
                    <td>${rate.buy.toFixed(2)}</td>
                    <td>${rate.sell.toFixed(2)}</td>
                    <td>${rate.date}</td>
                `;
                tbodyHist.appendChild(row);
            });

        } catch (err) {
            console.error('Error loading rates', err);
        }
    }

    loadRates();
    setInterval(loadRates, 60 * 1000); // refresh every minute
    </script>
</body>
</html>
